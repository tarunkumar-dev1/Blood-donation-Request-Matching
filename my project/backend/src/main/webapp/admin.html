<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Admin Portal - Blood Donation</title>
	<link rel="stylesheet" href="css/style.css" />
	<style>
		.admin-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
		.admin-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
		.admin-header h1 { margin: 0 0 10px 0; font-size: 2.5em; }
		.admin-header p { margin: 0; opacity: 0.9; }
		.stats-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
		.stat-box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-left: 4px solid #667eea; }
		.stat-box h3 { margin: 0 0 10px 0; color: #666; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
		.stat-box .number { font-size: 2.5em; font-weight: bold; color: #333; margin: 10px 0; }
		.stat-box .change { font-size: 0.85em; color: #10b981; }
		.matches-section { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px; }
		.matches-section h2 { margin: 0 0 20px 0; color: #333; display: flex; align-items: center; justify-content: space-between; }
		.refresh-btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9em; }
		.refresh-btn:hover { background: #5568d3; }
		.match-card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #10b981; }
		.match-card.urgent { border-left-color: #ef4444; background: #fef2f2; }
		.match-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
		.match-type { font-weight: bold; font-size: 1.1em; color: #333; }
		.match-status { padding: 5px 15px; border-radius: 20px; font-size: 0.85em; font-weight: 600; }
		.match-status.new { background: #10b981; color: white; }
		.match-status.pending { background: #f59e0b; color: white; }
		.match-status.completed { background: #6b7280; color: white; }
		.match-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
		.match-detail { display: flex; flex-direction: column; }
		.match-detail label { font-size: 0.85em; color: #666; margin-bottom: 5px; }
		.match-detail value { font-weight: 600; color: #333; }
		.match-actions { margin-top: 15px; display: flex; gap: 10px; }
		.match-actions button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: 500; }
		.btn-approve { background: #10b981; color: white; }
		.btn-approve:hover { background: #059669; }
		.btn-contact { background: #3b82f6; color: white; }
		.btn-contact:hover { background: #2563eb; }
		.btn-reject { background: #ef4444; color: white; }
		.btn-reject:hover { background: #dc2626; }
		.no-matches { text-align: center; padding: 40px; color: #666; }
		.no-matches svg { width: 64px; height: 64px; margin-bottom: 20px; opacity: 0.5; }
		.tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; }
		.tab { padding: 12px 24px; cursor: pointer; border: none; background: none; font-size: 1em; color: #6b7280; border-bottom: 2px solid transparent; margin-bottom: -2px; }
		.tab.active { color: #667eea; border-bottom-color: #667eea; font-weight: 600; }
		.tab:hover { color: #667eea; }
		.priority-high { color: #ef4444; font-weight: bold; }
		.priority-medium { color: #f59e0b; font-weight: bold; }
		.priority-low { color: #10b981; font-weight: bold; }
		@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
		.loading { animation: pulse 2s ease-in-out infinite; }
	</style>
</head>
<body>
	<div class="admin-container">
		<div class="admin-header" style="display: flex; justify-content: space-between; align-items: center;">
			<div>
				<h1 style="margin: 0 0 10px 0;">ü©∏ Admin Portal</h1>
				<p style="margin: 0; opacity: 0.9;">Blood Donation Management System - Real-time Donor & Request Matching</p>
			</div>
			<div style="text-align: right; color: white;">
				<div style="margin-bottom: 10px; font-size: 1.1em; font-weight: 500; letter-spacing: 0.5px;">üëã Welcome <strong style="font-size: 1.2em; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">Tarun</strong></div>
				<button onclick="adminLogout()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;">Logout</button>
			</div>
		</div>

		<div class="stats-overview">
			<div class="stat-box">
				<h3>Total Matches</h3>
				<div class="number" id="totalMatches">0</div>
				<div class="change">‚Üë Updated in real-time</div>
			</div>
			<div class="stat-box">
				<h3>Pending Matches</h3>
				<div class="number" id="pendingMatches">0</div>
				<div class="change">Awaiting approval</div>
			</div>
			<div class="stat-box">
				<h3>Successful Matches</h3>
				<div class="number" id="successfulMatches">0</div>
				<div class="change">‚úì Completed</div>
			</div>
			<div class="stat-box">
				<h3>Available Donors</h3>
				<div class="number" id="availableDonors">0</div>
				<div class="change">Ready to donate</div>
			</div>
		</div>

		<div class="matches-section">
			<h2>
				<span>Matched Requests & Donors</span>
				<button class="refresh-btn" onclick="loadMatches()">üîÑ Refresh</button>
			</h2>

			<div class="tabs">
				<button class="tab active" onclick="filterMatches('all')">All Matches</button>
				<button class="tab" onclick="filterMatches('new')">New</button>
				<button class="tab" onclick="filterMatches('pending')">Pending</button>
				<button class="tab" onclick="filterMatches('completed')">Completed</button>
			</div>

			<div id="matchesContainer">
				<div class="no-matches loading">
					<div>Loading matches...</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		let allMatches = [];
		let currentFilter = 'all';

		// Check admin session on page load
		document.addEventListener('DOMContentLoaded', function() {
			checkAdminSession();
		});

		// Check if admin is authenticated
		async function checkAdminSession() {
			try {
				const response = await fetch('/api/admin/check-session');
				const data = await response.json();
				
				if (!data.authenticated && !data.loggedIn) {
					// Redirect to login if not authenticated
					window.location.href = 'admin-login.html';
				} else {
					// Load matches and refresh every 15 seconds
					loadMatches();
					setInterval(loadMatches, 15000);
				}
			} catch (error) {
				console.error('Session check failed:', error);
				// Redirect to login on error
				window.location.href = 'admin-login.html';
			}
		}

		// Admin logout function
		async function adminLogout() {
			try {
				const response = await fetch('/api/admin/login', {
					method: 'DELETE',
					headers: {
						'Content-Type': 'application/json'
					}
				});
				
				if (response.ok) {
					window.location.href = 'admin-login.html';
				}
			} catch (error) {
				console.error('Logout failed:', error);
				window.location.href = 'admin-login.html';
			}
		}

		async function loadMatches() {
			try {
				const response = await fetch('/api/admin/matches');
				if (!response.ok) throw new Error('Failed to load matches');
				
				const data = await response.json();
				allMatches = data.matches || [];
				
				// Update statistics
				document.getElementById('totalMatches').textContent = allMatches.length;
				document.getElementById('pendingMatches').textContent = 
					allMatches.filter(m => m.status === 'pending').length;
				document.getElementById('successfulMatches').textContent = 
					allMatches.filter(m => m.status === 'completed').length;
				document.getElementById('availableDonors').textContent = data.availableDonors || 0;
				
				// Display matches
				displayMatches(allMatches);
			} catch (error) {
				console.error('Error loading matches:', error);
				document.getElementById('matchesContainer').innerHTML = 
					'<div class="no-matches"><div>Error loading matches. Please try again.</div></div>';
			}
		}

		function filterMatches(filter) {
			currentFilter = filter;
			// Update active tab
			document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
			event.target.classList.add('active');
			
			let filtered = allMatches;
			if (filter !== 'all') {
				filtered = allMatches.filter(m => m.status === filter);
			}
			displayMatches(filtered);
		}

		function displayMatches(matches) {
			const container = document.getElementById('matchesContainer');
			
			if (matches.length === 0) {
				container.innerHTML = `
					<div class="no-matches">
						<div>No ${currentFilter === 'all' ? '' : currentFilter} matches found</div>
						<p style="margin-top: 10px; font-size: 0.9em;">Matches will appear here when donors match blood requests</p>
					</div>
				`;
				return;
			}

			container.innerHTML = matches.map(match => `
				<div class="match-card ${match.priority === 'high' ? 'urgent' : ''}">
					<div class="match-header">
						<div>
							<div class="match-type">ü©∏ ${match.bloodType} Blood Match</div>
							<div style="font-size: 0.85em; color: #666; margin-top: 5px;">
								Match ID: ${match.matchId} | Priority: <span class="priority-${match.priority}">${match.priority.toUpperCase()}</span>
							</div>
						</div>
						<span class="match-status ${match.status}">${match.status.toUpperCase()}</span>
					</div>
					
					<div class="match-details">
						<div class="match-detail">
							<label>üë§ Donor Name</label>
							<value>${match.donorName}</value>
						</div>
						<div class="match-detail">
							<label>üìû Donor Phone</label>
							<value>${match.donorPhone}</value>
						</div>
						<div class="match-detail">
							<label>üè• Request By</label>
							<value>${match.requestName}</value>
						</div>
						<div class="match-detail">
							<label>üìß Request Email</label>
							<value>${match.requestEmail}</value>
						</div>
						<div class="match-detail">
							<label>üìç Location Match</label>
							<value>${match.locationMatch ? '‚úì Same Area' : '‚ö† Different Area'}</value>
						</div>
						<div class="match-detail">
							<label>‚è∞ Matched At</label>
							<value>${new Date(match.matchedAt).toLocaleString()}</value>
						</div>
					</div>

					${match.requestNote ? `
						<div style="margin-top: 15px; padding: 10px; background: white; border-radius: 6px;">
							<label style="font-size: 0.85em; color: #666;">üìù Request Note:</label>
							<div style="margin-top: 5px; color: #333;">${match.requestNote}</div>
						</div>
					` : ''}

					<div class="match-actions">
						${match.status === 'new' ? `
							<button class="btn-approve" onclick="approveMatch('${match.matchId}')">‚úì Approve Match</button>
							<button class="btn-contact" onclick="contactParties('${match.matchId}')">üìû Contact Both</button>
							<button class="btn-reject" onclick="rejectMatch('${match.matchId}')">‚úó Reject</button>
						` : match.status === 'pending' ? `
							<button class="btn-approve" onclick="completeMatch('${match.matchId}')">‚úì Mark Complete</button>
							<button class="btn-contact" onclick="contactParties('${match.matchId}')">üìû Follow Up</button>
						` : `
							<button class="btn-contact" onclick="viewDetails('${match.matchId}')">üìÑ View Details</button>
						`}
					</div>
				</div>
			`).join('');
		}

		async function approveMatch(matchId) {
			if (!confirm('Approve this match and notify both parties?')) return;
			try {
				const response = await fetch('/api/admin/matches/approve', {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: new URLSearchParams({ matchId })
				});
				if (response.ok) {
					alert('Match approved! Both parties will be notified.');
					loadMatches();
				}
			} catch (error) {
				alert('Error approving match');
			}
		}

		async function completeMatch(matchId) {
			if (!confirm('Mark this match as completed?')) return;
			try {
				const response = await fetch('/api/admin/matches/complete', {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: new URLSearchParams({ matchId })
				});
				if (response.ok) {
					alert('Match marked as completed!');
					loadMatches();
				}
			} catch (error) {
				alert('Error completing match');
			}
		}

		function contactParties(matchId) {
			alert('Contact feature: Send SMS/Email to both donor and requester\nMatch ID: ' + matchId);
		}

		function rejectMatch(matchId) {
			if (!confirm('Reject this match?')) return;
			alert('Match rejected. This feature will be fully implemented.');
			loadMatches();
		}

		function viewDetails(matchId) {
			alert('View detailed history for match: ' + matchId);
		}
	</script>
</body>
</html>
